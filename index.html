<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Controle de Sa√≠das - Firebase Avan√ßado</title>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

<header class="bg-blue-600 text-white p-4 text-center font-bold text-xl">üöó Controle de Sa√≠das</header>

<!-- LOGIN -->
<div id="loginPage" class="flex-1 flex items-center justify-center">
  <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
    <h2 class="text-2xl font-bold mb-4 text-center">Login</h2>
    <input id="username" placeholder="Usu√°rio" class="w-full p-2 border rounded mb-2">
    <input id="password" placeholder="Senha" type="password" class="w-full p-2 border rounded mb-4">
    <button id="loginBtn" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700">Entrar</button>
  </div>
</div>

<!-- APP -->
<div id="mainPage" class="hidden flex-1 flex flex-col p-4">

  <!-- FORMUL√ÅRIO -->
  <form id="carForm" class="bg-white p-4 rounded-xl shadow space-y-2">
    <input type="date" id="date" class="w-full p-2 border rounded" required>
    <select id="driver" class="w-full p-2 border rounded" required>
      <option value="">-- Selecione Condutor --</option>
      <option value="Cristiano">Cristiano</option>
      <option value="Gabriel">Gabriel</option>
      <option value="Roberto">Roberto</option>
    </select>
    <input type="time" id="timeStart" class="w-full p-2 border rounded" required>
    <input type="time" id="timeEnd" class="w-full p-2 border rounded" required>
    <input type="number" id="kmStart" placeholder="Km Inicial" class="w-full p-2 border rounded" required>
    <input type="number" id="kmEnd" placeholder="Km Final" class="w-full p-2 border rounded" required>
    <input type="number" id="fuel" placeholder="Litros Abastecidos (opcional)" class="w-full p-2 border rounded">
    <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded hover:bg-blue-700">Registrar</button>
  </form>

  <!-- FILTRO -->
  <div class="mt-4 flex gap-2 items-center">
    <label>Filtrar por data:</label>
    <input type="date" id="filterStart" class="p-2 border rounded">
    <input type="date" id="filterEnd" class="p-2 border rounded">
    <button id="filterBtn" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Filtrar</button>
    <button id="clearFilterBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-700">Limpar</button>
  </div>

  <!-- HIST√ìRICO -->
  <h2 class="text-xl font-bold mt-4 mb-2">Hist√≥rico</h2>
  <div class="overflow-x-auto bg-white p-2 rounded-xl shadow">
    <table class="w-full text-center border border-gray-300" id="historyTable">
      <thead class="bg-blue-600 text-white">
        <tr>
          <th>Data</th><th>Condutor</th><th>Sa√≠da</th><th>Chegada</th><th>Km Inicial</th><th>Km Final</th><th>Km Percorrida</th><th>Combust√≠vel</th>
          <th id="adminColumn" class="hidden">Excluir</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- EXPORTA√á√ÉO -->
  <div class="mt-4 flex gap-2">
    <button id="exportCSV" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Exportar CSV</button>
    <button id="exportTXT" class="bg-gray-700 text-white px-4 py-2 rounded hover:bg-gray-900">Exportar TXT</button>
  </div>

  <!-- GR√ÅFICOS -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
    <div class="bg-white p-4 rounded-xl shadow">
      <h3 class="text-xl font-semibold mb-2">Km Percorridos por Condutor</h3>
      <canvas id="kmChart"></canvas>
    </div>
    <div class="bg-white p-4 rounded-xl shadow">
      <h3 class="text-xl font-semibold mb-2">Consumo M√©dio (Km/L)</h3>
      <canvas id="consumoChart"></canvas>
    </div>
  </div>
</div>

<script>
// üîπ CONFIG FIREBASE
const firebaseConfig = {
  apiKey: "AIzaSyDV7CNAxkfowHWltr-E3BHimLSMb_LaAbI",
  authDomain: "controle-saidas-3ccd7.firebaseapp.com",
  projectId: "controle-saidas-3ccd7",
  storageBucket: "controle-saidas-3ccd7.firebasestorage.app",
  messagingSenderId: "1047924790652",
  appId: "1:1047924790652:web:104a482faf08879cf540f9"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// üîπ VARI√ÅVEIS
const loginPage = document.getElementById('loginPage');
const mainPage = document.getElementById('mainPage');
const historyTableBody = document.querySelector("#historyTable tbody");
const adminColumn = document.getElementById('adminColumn');
let kmChart, consumoChart;

// Usu√°rios fixos
const users = { 'Cristiano':'1234','Gabriel':'1234','Roberto':'1234','admin':'admin123' };
let isAdmin = false;

// üîπ LOGIN
document.getElementById('loginBtn').addEventListener('click', ()=>{
  const username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  if(users[username] && users[username]===password){
    isAdmin = username==='admin';
    loginPage.classList.add('hidden');
    mainPage.classList.remove('hidden');
    if(isAdmin) adminColumn.classList.remove('hidden');
    loadRecords();
  } else alert("Usu√°rio ou senha incorretos!");
});

// üîπ REGISTRO DE SA√çDA
document.getElementById('carForm').addEventListener('submit', async e=>{
  e.preventDefault();
  const date = document.getElementById('date').value;
  const driver = document.getElementById('driver').value;
  const timeStart = document.getElementById('timeStart').value;
  const timeEnd = document.getElementById('timeEnd').value;
  const kmStart = parseFloat(document.getElementById('kmStart').value);
  const kmEnd = parseFloat(document.getElementById('kmEnd').value);
  const fuel = parseFloat(document.getElementById('fuel').value||0);
  const kmTravelled = kmEnd - kmStart;

  await db.collection("registros").add({date,driver,timeStart,timeEnd,kmStart,kmEnd,kmTravelled,fuel});
  e.target.reset();
  loadRecords();
});

// üîπ CARREGAR REGISTROS
async function loadRecords(startDate, endDate){
  let query = db.collection("registros").orderBy("date","desc");
  if(startDate) query = query.where("date", ">=", startDate);
  if(endDate) query = query.where("date", "<=", endDate);

  const snapshot = await query.get();
  historyTableBody.innerHTML = "";
  const records = [];
  snapshot.forEach(doc=>{
    const r = doc.data();
    r.id = doc.id;
    records.push(r);

    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.driver}</td><td>${r.timeStart}</td><td>${r.timeEnd}</td><td>${r.kmStart}</td><td>${r.kmEnd}</td><td>${r.kmTravelled}</td><td>${r.fuel}</td>`;
    if(isAdmin){
      const td = document.createElement('td');
      const btn = document.createElement('button');
      btn.textContent = "üóëÔ∏è";
      btn.className = "bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700";
      btn.onclick = async ()=>{ await db.collection("registros").doc(r.id).delete(); loadRecords(); };
      td.appendChild(btn);
      tr.appendChild(td);
    }
    historyTableBody.appendChild(tr);
  });
  updateCharts(records);
}

// üîπ FILTRO
document.getElementById('filterBtn').addEventListener('click', ()=>{
  const start = document.getElementById('filterStart').value;
  const end = document.getElementById('filterEnd').value;
  loadRecords(start,end);
});
document.getElementById('clearFilterBtn').addEventListener('click', ()=>{
  document.getElementById('filterStart').value = "";
  document.getElementById('filterEnd').value = "";
  loadRecords();
});

// üîπ EXPORTA√á√ÉO
document.getElementById('exportCSV').addEventListener('click', async ()=>{
  const snapshot = await db.collection("registros").get();
  let csv = "Data,Condutor,Sa√≠da,Chegada,Km Inicial,Km Final,Km Percorrida,Combust√≠vel\n";
  snapshot.forEach(doc=>{
    const r = doc.data();
    csv += `${r.date},${r.driver},${r.timeStart},${r.timeEnd},${r.kmStart},${r.kmEnd},${r.kmTravelled},${r.fuel}\n`;
  });
  downloadFile(csv,"registros.csv","text/csv");
});
document.getElementById('exportTXT').addEventListener('click', async ()=>{
  const snapshot = await db.collection("registros").get();
  let txt = "Data | Condutor | Sa√≠da | Chegada | Km Inicial | Km Final | Km Percorrida | Combust√≠vel\n";
  snapshot.forEach(doc=>{
    const r = doc.data();
    txt += `${r.date} | ${r.driver} | ${r.timeStart} | ${r.timeEnd} | ${r.kmStart} | ${r.kmEnd} | ${r.kmTravelled} | ${r.fuel}\n`;
  });
  downloadFile(txt,"registros.txt","text/plain");
});
function downloadFile(content,fileName,mimeType){
  const blob = new Blob([content],{type:mimeType});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = fileName; a.click();
  URL.revokeObjectURL(url);
}

// üîπ GR√ÅFICOS
function updateCharts(records){
  const condutores = [...new Set(records.map(r=>r.driver))];
  const colors = condutores.map((_,i)=>`hsl(${i*60%360},70%,50%)`);
  const kmData = condutores.map(d=>records.filter(r=>r.driver===d).reduce((a,b)=>a+b.kmTravelled,0));
  const consumoData = condutores.map(d=>{
    const rec = records.filter(r=>r.driver===d && r.fuel>0);
    const totalKm = rec.reduce((a,b)=>a+b.kmTravelled,0);
    const totalFuel = rec.reduce((a,b)=>a+b.fuel,0);
    return totalFuel>0?(totalKm/totalFuel).toFixed(2):0;
  });

  if(kmChart) kmChart.destroy();
  if(consumoChart) consumoChart.destroy();

  kmChart = new Chart(document.getElementById('kmChart'),{
    type:'bar',
    data:{labels:condutores,datasets:[{label:'Km Percorridos',data:kmData,backgroundColor:colors}]},
    options:{responsive:true,plugins:{legend:{display:false}}}
  });
  consumoChart = new Chart(document.getElementById('consumoChart'),{
    type:'bar',
    data:{labels:condutores,datasets:[{label:'Km/L',data:consumoData,backgroundColor:colors}]},
    options:{responsive:true,plugins:{legend:{display:false}}}
  });
}
</script>

</body>
</html>
